# 开发步骤（MVP，按流水线拆解）

## 0. 准备与选型
- 前端：Vite + 轻量 Preact/React，纯静态产物；iOS Safari 兼容（HTTPS，用户手势开麦）。
- 后端：Python 3.11+（FastAPI/Starlette + Uvicorn/WebSocket）；Postgres；Nginx 反代/静态托管；任务队列 Celery/RQ（可选 Redis）。
- AI/服务：Whisper 本地推理，百度翻译 API，DeepSeek LLM，总结与示意图描述；文档导出 python-docx + Markdown→PDF。
- 环境：前端机 2GB（主站）+0.5GB（镜像）；后端机 16GB，安装 Python/Whisper 依赖/证书/PG；证书手动申请。

## 1. 里程碑与验收分段
- M0 登录/鉴权：管理员预置用户，登录拿 Token，全链路鉴权。
- M1 实时英文字幕：WS 采集 → Whisper ASR → 推送 EN → 落库 utterance。
- M2 中译与推送：在 M1 基础上接入百度翻译，推送 EN/ZH，落库。
- M3 总结与导出：结束讲座触发 DeepSeek 摘要/要点/QA/提纲，前端拼 Markdown，导出 EN/EN-ZH/summary md/txt/Word/PDF。
- M4 弱网补传与运维：补传接口重跑 ASR/翻译；监控/日志/health。

## 2. 数据与接口基建
- 建表：user(username/password_hash/role/token)、lecture、utterance、summary、export_job（见《开发文档.md》），加索引。
- 后端脚手架：HTTP 路由 + WSS 路由，Bearer 鉴权中间件，Admin health。
- 基础 API：登录 `/api/auth/login`，`POST /api/lectures`、`/join`、`/end`、`GET /lectures`/`/{id}`。

## 3. 阶段1：ASR 实时链路（M1）
- 客户端：16 kHz mono PCM，0.5–2s 分片，经 WSS；心跳/重连。
- 服务端：lecture_id 房间管理，seq 生成；接收帧入队；Whisper 推理（small/medium 视硬件）→ EN+时间戳。
- 推送：广播 EN（可先无 ZH），异步落库 utterance；错误码与重试；监控推理耗时。

## 4. 阶段2：翻译链路（M2）
- 集成翻译：百度翻译 API EN→ZH，支持批量/分段，超时重试和限流；失败可降级为空译文但不中断字幕。
- 推送：广播 `{lecture_id, seq, start_ms, end_ms, text_en, text_zh}`；落库包含中译。

## 5. 阶段3：LLM 总结与导出（M3）
- 结束触发：`POST /api/lectures/{id}/end` 创建总结任务。
- 汇总全文：按 seq 拼 EN 文本（可附时间戳范围）。
- 调 DeepSeek：生成摘要、要点、QA、提纲、示意图描述，写 summary（含 model_version）。`/summaries/rebuild` 支持重跑。
- 导出：`POST /api/lectures/{id}/exports` (kind: en|en_zh|summary_md|summary_pdf|en_docx|en_zh_docx|summary_docx) 生成 md/txt/Word/PDF，写 export_job；`GET /api/exports/{job_id}` 查询；文件存储磁盘/对象存储。
- 前端：可自行拼 Markdown 预览，导出交给后端。

## 6. 弱网补传（M4）
- HTTP 上传整段音频接口；后台重跑 ASR+翻译，回填 utterance，必要时重新导出。
- 客户端：断网缓存音频，恢复后批量上传；重连自动 join 同 lecture_id。

## 7. 前端实现
- 登录：用户名/密码登录页，持久化 Token，未登录拦截；无注册入口。
- 讲座列表：创建/加入入口，状态展示。
- 讲座详情：WSS 连接，实时英/中字幕双列，网络/延迟提示，结束按钮。
- 总结/导出：展示摘要/要点/QA/示意图描述，Markdown 预览中英对照，显示导出链接（md/txt/Word/PDF）。
- AI 文档拼装：用翻译稿+总结在前端生成 Markdown（含 Mermaid/ASCII 占位图），提交后端导出。
- 体积优化：无重 UI 库，懒加载，打包压缩，适配 0.5GB 静态机。

## 8. 部署
- 前端：Vite 构建 → Nginx 静态托管；反代 `/api` `/ws` 到后端；0.5GB 机做静态镜像。
- 证书：已有域名，手动申请/更新证书；测试可自签，生产必须 HTTPS/WSS。
- 后端：部署服务（systemd/docker），配置 HTTPS/WSS，连接 Postgres；配置 Whisper 依赖（GPU 优先）、百度翻译密钥、DeepSeek 密钥。
- Postgres：初始化表/用户，备份/checkpoint 调优；导出文件落地磁盘或对象存储。

## 9. 监控与验收
- 指标：ASR/翻译/DeepSeek 错误率，WS 连接数，队列积压，CPU/内存，Whisper 推理耗时。
- 日志：请求/错误/耗时，脱敏；health/metrics 接口可用。
- 验收：正常网络端到端字幕延迟 ≤2s；登录鉴权全链路；结束后可得摘要/导出（md/txt/Word/PDF）；弱网补传可恢复完整稿件。
