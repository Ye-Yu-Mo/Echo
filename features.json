{
  "M0_登录与鉴权_基础设施": {
    "core": "管理员预置用户，登录返回Bearer Token，全链路鉴权校验，讲座管理API，WS鉴权心跳，任务队列，文件存储约定",
    "sub_features": {
      "后端_建表": {
        "description": "Postgres建表：user/lecture/utterance(含source字段区分realtime/reprocess)/summary/export_job/audio_upload(lecture_id/file_uri/status/duration/checksum去重)，含索引（summaries唯一约束防重复is_latest、utterances按source拉取增量）",
        "finish": true
      },
      "后端_数据库连接池": {
        "description": "配置Postgres连接池（psycopg3 pool 2-10连接），预置管理员用户admin/admin123（schema.sql内置bcrypt hash），init-db CLI命令",
        "finish": true
      },
      "后端_登录接口": {
        "description": "POST /api/auth/login（bcrypt验证+时序攻击防护），POST /api/auth/logout，返回secrets.token_hex(32)生成的256位随机Token",
        "finish": true
      },
      "后端_鉴权中间件": {
        "description": "Bearer Token校验中间件（精确路径匹配避免前缀误放行），所有API/WS需带Token，用户信息注入request.state",
        "finish": true
      },
      "后端_讲座管理API": {
        "description": "POST /api/lectures（创建），POST /api/lectures/{id}/join（加入），GET /api/lectures（列表+分页），GET /api/lectures/{id}（详情），POST /api/lectures/{id}/end（结束），全部含权限检查（仅创建者可操作）",
        "finish": true
      },
      "后端_WS鉴权心跳": {
        "description": "WS握手校验Token（query参数?token=xxx），ping/pong心跳（30s间隔），断线自动清理连接集合，占位echo测试可用",
        "finish": true
      },
      "后端_任务队列基础": {
        "description": "进程内队列（asyncio.Queue + 2 workers），submit_task提交异步任务，startup/shutdown生命周期管理（待修复：shutdown可能阻塞）",
        "finish": true
      },
      "后端_文件存储约定": {
        "description": "本地磁盘存储 exports/ uploads/（路径穿越防护：..和绝对路径检查+resolve二次验证），过期清理（7天），save_file/get_file_path/delete_file",
        "finish": true
      },
      "前端_登录页面": {
        "description": "用户名/密码表单，登录成功后持久化Token（localStorage）",
        "finish": false
      },
      "前端_路由守卫": {
        "description": "未登录时拦截所有页面跳转到登录页",
        "finish": false
      }
    },
    "finish": false,
    "notes": "后端90%完成，已修复5个安全漏洞（路径穿越、越权、唯一约束、时序攻击、路径误放行），待修复3个稳定性问题（DB异常处理、WS并发安全、shutdown阻塞）"
  },
  "M1_实时英文字幕": {
    "core": "客户端采集音频→WS推送→后端Whisper ASR→广播EN字幕→异步落库",
    "sub_features": {
      "后端_Whisper集成": {
        "description": "本地Whisper推理（small/medium模型），输入PCM音频帧，输出EN文本+时间戳",
        "finish": false
      },
      "后端_WS房间管理": {
        "description": "lecture_id→连接集合映射，支持多客户端订阅同一讲座",
        "finish": false
      },
      "后端_seq生成": {
        "description": "每个讲座seq单调递增，广播时带seq保证顺序",
        "finish": false
      },
      "后端_广播EN字幕": {
        "description": "ASR完成后广播{lecture_id, seq, start_ms, end_ms, text_en}到所有连接",
        "finish": false
      },
      "后端_异步落库utterance": {
        "description": "字幕写入utterance表（队列或后台任务），source='realtime'，避免阻塞广播",
        "finish": false
      },
      "前端_麦克风采集": {
        "description": "用户手势触发getUserMedia，16kHz mono PCM，0.5–2s分片",
        "finish": false
      },
      "前端_WSS推送音频": {
        "description": "通过WSS发送二进制音频帧，带Token鉴权",
        "finish": false
      },
      "前端_字幕显示_EN": {
        "description": "实时显示英文字幕，先不显示中文",
        "finish": false
      },
      "前端_讲座管理": {
        "description": "创建/加入讲座，结束按钮",
        "finish": false
      }
    },
    "finish": false
  },
  "M2_中译与推送": {
    "core": "在M1基础上接入百度翻译，广播EN+ZH双语字幕",
    "sub_features": {
      "后端_百度翻译集成": {
        "description": "调用百度翻译API，支持批量/分段，超时重试与限流保护",
        "finish": false
      },
      "后端_广播EN_ZH字幕": {
        "description": "ASR→翻译→广播{..., text_en, text_zh}",
        "finish": false
      },
      "后端_落库包含text_zh": {
        "description": "utterance表写入中译",
        "finish": false
      },
      "前端_双列字幕显示": {
        "description": "英文上方，中文下方，双列实时展示",
        "finish": false
      }
    },
    "finish": false
  },
  "M3_总结与导出": {
    "core": "结束讲座后，DeepSeek生成摘要/要点/QA/提纲，导出EN/EN-ZH/summary（md/txt/Word/PDF）",
    "sub_features": {
      "后端_结束讲座接口": {
        "description": "POST /api/lectures/{id}/end，触发总结任务",
        "finish": false
      },
      "后端_DeepSeek集成": {
        "description": "汇总英文全文，调DeepSeek生成摘要/要点/QA/提纲/示意图描述，写summary表",
        "finish": false
      },
      "后端_总结查询接口": {
        "description": "GET /api/lectures/{id}/summaries，返回多种类型总结",
        "finish": false
      },
      "后端_导出接口": {
        "description": "POST /api/lectures/{id}/exports (kind: en|en_zh|summary_md|summary_pdf|en_docx|en_zh_docx|summary_docx)，生成文件，写export_job",
        "finish": false
      },
      "后端_导出文件生成": {
        "description": "生成md/txt（纯文本），python-docx生成Word，Markdown→HTML→PDF（WeasyPrint/wkhtmltopdf）",
        "finish": false
      },
      "后端_导出任务查询": {
        "description": "GET /api/exports/{job_id}，返回任务状态与下载链接",
        "finish": false
      },
      "前端_总结展示页": {
        "description": "讲座详情页展示摘要/要点/QA/提纲",
        "finish": false
      },
      "前端_Markdown预览": {
        "description": "前端拼装中英对照Markdown，在线预览（markdown-it），支持Mermaid占位图",
        "finish": false
      },
      "前端_导出下载": {
        "description": "导出按钮（md/txt/Word/PDF），轮询任务状态，展示下载链接",
        "finish": false
      }
    },
    "finish": false
  },
  "M4_弱网补传与运维": {
    "core": "断网缓存音频，恢复后HTTP补传重跑ASR+翻译；监控/日志/health可用",
    "sub_features": {
      "后端_HTTP音频上传": {
        "description": "POST /api/lectures/{id}/audio，上传整段音频，写audio_upload表(file_uri/status/duration)，后台重跑ASR+翻译，回填utterance(source='reprocess')，避免覆盖实时字幕",
        "finish": false
      },
      "后端_监控指标": {
        "description": "GET /api/admin/metrics，返回ASR/翻译/LLM错误率、WS连接数、队列积压、CPU/内存",
        "finish": false
      },
      "后端_日志接口": {
        "description": "GET /api/admin/logs，查询请求/错误/耗时日志，脱敏",
        "finish": false
      },
      "后端_错误码规范": {
        "description": "统一错误码（1001 unauthorized，2001 asr_failed等），WS与HTTP都用",
        "finish": false
      },
      "前端_断网缓存音频": {
        "description": "检测断网时本地IndexedDB/Blob缓存音频片段，恢复后批量POST上传，触发重跑任务",
        "finish": false
      },
      "前端_网络状态提示": {
        "description": "显示网络状态（正常/断线/重连中），延迟提示",
        "finish": false
      }
    },
    "finish": false
  },
  "部署与环境": {
    "core": "Postgres初始化、环境变量配置、Nginx反代、HTTPS/WSS证书、Whisper模型部署",
    "sub_features": {
      "数据库初始化": {
        "description": "Postgres建库建表，管理员预置用户，索引创建",
        "finish": false
      },
      "环境变量配置": {
        "description": "DATABASE_URL/BAIDU_APP_ID/BAIDU_APP_KEY/DEEPSEEK_API_KEY/WHISPER_MODEL_PATH",
        "finish": false
      },
      "Nginx配置": {
        "description": "前端静态托管+反代/api和/ws到后端，gzip/brotli压缩",
        "finish": false
      },
      "HTTPS_WSS证书": {
        "description": "手动申请正式证书或自签测试，配置Nginx HTTPS/WSS",
        "finish": false
      },
      "Whisper模型部署": {
        "description": "下载small/medium模型，配置GPU推理环境（或CPU降级）",
        "finish": false
      }
    },
    "finish": false
  }
}
