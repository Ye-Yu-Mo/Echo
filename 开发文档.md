# 开发文档（MVP 首版）

## 1. 范围与目标
- 覆盖最小闭环：创建/加入/结束讲座 → Web 实时英/中字幕 → 结束后摘要/要点/QA → 前端生成中英对照 Markdown → 后端导出 EN/EN-ZH/summary（md/txt/Word/PDF）。
- 平台：Web 优先，兼容 iOS Safari。后续可接 App/小程序。
- 架构：前后端分离；后端指定 Python（FastAPI/Starlette + Uvicorn/WebSocket）；前端静态资源部署在 2GB/0.5GB 机器；后端单机 16GB。
- AI/外部：ASR Whisper（本地/自托管），翻译百度翻译 API，LLM DeepSeek（总结/提纲/示意图描述），文档处理 python-docx + Markdown→PDF 渲染。
- 安全：全站 HTTPS/WSS，Bearer Token 鉴权，有限用户登录（无公开注册），按用户隔离数据。

## 2. 整体架构
- 前端：静态页面（Vite 构建，Preact/轻量 React），Nginx/静态托管；可选极薄反向代理转发 `/api` 和 `/ws`；前端合成中英对照 Markdown，在线预览+下载。
- 后端：Python HTTP+WSS 服务（FastAPI/Starlette + Uvicorn），负责会话管理、WS 音频摄取、Whisper ASR、百度翻译、广播、DeepSeek 总结/示意图描述、导出 Word/PDF、弱网补传；耗时任务用 Celery/RQ（可先进程内）。
- 数据层：Postgres 存元数据（lecture/utterance/summary/export_job/user）；对象存储或本地磁盘存音频、导出文件；Redis 可选做队列/缓存。
- 外部依赖：Whisper（自托管推理），百度翻译 API，DeepSeek LLM（HTTP），PDF 渲染器（wkhtmltopdf/WeasyPrint）。

## 3. 技术选型
- 前端：Vite + Preact/React（最少依赖），打包产物 < 1–2 MB gzip，兼容 iOS Safari。音频采集用 Web Audio + MediaRecorder/AudioWorklet，16 kHz mono PCM，0.5–2s 分片；Markdown 预览用轻量渲染器（如 markdown-it），支持 Mermaid/ASCII 占位图。
- 后端：Python 3.11+，FastAPI/Starlette + Uvicorn（ASGI + WebSocket）；后台任务 Celery/RQ（Redis/进程内）；ASR 用 Whisper 本地推理（small/medium 视资源），翻译用百度翻译 API，LLM 用 DeepSeek（总结/提纲/图示描述）；导出用 python-docx + Markdown→HTML→PDF（WeasyPrint/wkhtmltopdf）。
- 部署：前端 2GB 机跑 Nginx 静态和反代；0.5GB 机可做静态镜像或只分发文件。后端 16GB 单机运行 Python 服务和 Postgres（或托管 PG）；域名已有，证书手动申请与配置。

## 4. 数据模型（Postgres）
- `user(id, username, password_hash, role, token, created_at, disabled_at)`
- `lecture(id, title, creator_id, status[init|recording|summarizing|done], created_at, ended_at)`
- `utterance(id, lecture_id, seq, start_ms, end_ms, text_en, text_zh, created_at)`
- `summary(id, lecture_id, type[general_summary|outline|qa|key_concepts|key_examples], content, model_version, created_at)`
- `export_job(id, lecture_id, kind[en|en_zh|summary_md|summary_pdf], status, file_uri, created_at)`

索引：`user(username)`；`utterance(lecture_id, seq)`；`summary(lecture_id)`；`lecture(status, created_at)`；`export_job(lecture_id, status)`。

## 5. API 设计（MVP）
HTTP（Bearer Token，HTTPS）：
- POST `/api/auth/login` → {token}（管理员预置账号，返回短期 Token）
- POST `/api/lectures` → {lecture_id}
- POST `/api/lectures/{id}/join`
- POST `/api/lectures/{id}/end`（触发总结）
- GET `/api/lectures` / `/api/lectures/{id}`
- POST `/api/lectures/{id}/summaries/rebuild`（DeepSeek 重跑）
- GET `/api/lectures/{id}/summaries`
- POST `/api/lectures/{id}/exports` body: {kind: en|en_zh|summary_md|summary_pdf|en_docx|en_zh_docx|summary_docx}
- GET `/api/exports/{job_id}`
- Admin: GET `/api/admin/health`, `/metrics`, `/logs`

WebSocket `/ws/lectures/{id}`（WSS）：
- 入站：binary PCM 分片（16 kHz mono，0.5–2s），header/meta 含 token/lecture_id；ping/pong 心跳。
- 出站事件：
  - `subtitle`: {lecture_id, seq, start_ms, end_ms, text_en, text_zh}
  - `info` / `error`: 状态与错误码。

错误码示例：`1001 unauthorized`，`1002 lecture_not_found`，`2001 asr_failed`，`2002 translate_failed`，`3001 rate_limited`，`4001 server_busy`。

## 6. 流程
### 6.1 实时字幕
客户端发 WSS 连接 → 发送音频帧 → 后端 Whisper ASR → 百度翻译 → 广播 subtitle → 异步写 utterance（队列）。

### 6.2 讲后总结
结束讲座 → 汇总英文（按 seq 排序）→ 调 DeepSeek 生成摘要/要点/QA/可选提纲/示意图描述 → 写 summary 表；允许重跑。

### 6.3 导出
生成文本/md（EN、EN-ZH、Summary），前端可整合 Markdown；后端将 Markdown 产出 Word（python-docx）和 PDF（HTML 渲染）。生成后写 export_job，产物存对象存储/磁盘，返回下载 URL 或轮询 job。

### 6.4 弱网补传
HTTP 上传整段音频 → 后台重跑 Whisper ASR + 百度翻译 → 回填 utterance → 可重新导出。

## 7. 前端实现要点
- 必须用户手势开启麦克风（iOS Safari 约束），HTTPS。
- 登录：简易用户名/密码登录，持久化 Token，未登录跳转登录页；无注册入口。
- 音频分片 0.5–2s，自动重连 WSS，重连后自动 join 同 lecture_id。
- UI：讲座列表/详情；实时英/中双列字幕；网络/延迟提示；结束按钮；导出/总结查看；Markdown 预览（中英对照）、下载按钮。
- AI 文档生成：前端可将原文/翻译/总结拼装 Markdown，支持 Mermaid/ASCII 占位图；导出请求交给后端生成 Word/PDF。
- 资源优化：最少依赖，避免大型 UI 库；可懒加载总结/导出页；适配 0.5GB 机的静态分发。

## 8. 后端实现要点
- 会话与鉴权：FastAPI 中间件校验 Bearer token；用户表本地验证 username/password_hash；lecture_id→房间映射，WS 连接表，seq 单调递增。
- ASR/翻译：Whisper 推理池（进程/线程，GPU 优先）；短超时 + 重试；翻译可批量；过长文本分段；可缓存相邻重复句。
- 推送与持久化：广播前推送，落库异步（队列）防阻塞；必要时 WAL/队列防丢；弱网情况下允许补传回填。
- 总结：结束触发任务；DeepSeek 调用记录 model_version；多版本共存；可重跑覆盖/追加；支持生成示意图描述字段。
- 导出：即时小文件，长文件用 job；job 状态轮询；生成 md/txt/Word/PDF，Word 用 python-docx，PDF 用 Markdown→HTML→渲染。
- 监控：ASR/翻译/DeepSeek 错误率、WS 连接数、队列积压、CPU/内存。

## 9. 部署与资源
- 前端 2GB 机：Nginx 静态托管 + 反代 `/api` `/ws` 到后端；开启 gzip/brotli；域名已备，证书需手动申请与续期（可先自签测试，正式必须 HTTPS/WSS）。
- 前端 0.5GB 机：静态镜像或文件分发，不跑反代也可。
- 后端 16GB：运行 Python 服务 + Postgres；Uvicorn 多 worker；Whisper 需 GPU 优先，CPU 降级需降低并发/模型尺寸；ASR/翻译/LLM 调用池化。
- Postgres：分配 1–2GB 内存；合理 checkpoint，必要时压缩/清理旧导出文件；可用对象存储/磁盘存导出与音频。

## 10. 安全与隐私
- 全站 HTTPS/WSS；按用户隔离 lecture 数据；日志脱敏（不记录原文/音频）。
- 用户仅管理员预置；Token 有效期短，支持注销；无注册接口。
- 提供删除接口；导出 URL 设置过期时间；对外接口限流。

## 11. MVP 验收标准
- Web（含 iOS Safari）实时英/中字幕可用，正常网络下端到端延迟 ≤ 2s。
- 登录流程可用（管理员预置账号），全程鉴权。
- 结束后能看到摘要/要点/QA，能导出 EN/EN-ZH/summary md/txt/Word/PDF。
- 弱网断线可补传，重跑后得到完整稿件。
- 基础 health/metrics/logs 可查询。

## 12. 后续可选优化
- 自动化证书续期；字幕回放（带时间轴）；细粒度权限/分享；Redis 队列与任务监控；模型版本/Prompt 管理；前端离线缓存。
